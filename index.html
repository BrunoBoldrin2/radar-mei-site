<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Radar MEI</title>

<style>

body{
  font-family: Arial, sans-serif;
  margin:0;
  background:#f5f7fb;
  color:#222;
}

.container{
  max-width:900px;
  margin:auto;
  padding:40px 20px;
  text-align:center;
}

h1{
  font-size:42px;
  margin-bottom:10px;
}

.subtitle{
  font-size:20px;
  color:#555;
  margin-bottom:40px;
}

.card{
  background:white;
  padding:30px;
  border-radius:12px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
}

input{
  padding:15px;
  font-size:18px;
  width:250px;
  border-radius:8px;
  border:1px solid #ccc;
}

button{
  margin-top:20px;
  padding:15px 25px;
  font-size:18px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:white;
  cursor:pointer;
}

button:hover{
  background:#1d4ed8;
}

.resultado{
  margin-top:25px;
  padding:20px;
  border-radius:10px;
  font-size:20px;
  font-weight:bold;
}

.loading{
  margin-top:10px;
  display:none;
  font-weight:bold;
}

</style>
</head>

<body>

<div class="container">

<h1>Radar MEI</h1>
<p class="subtitle">
Descubra antes se você vai ultrapassar o limite do MEI.
</p>

<div class="card">

<h2>Simule seu risco agora</h2>

<input id="valor" type="number" placeholder="Faturamento mensal (R$)">
<br>

<button id="botao" onclick="analisar()">Analisar risco</button>

<p id="loading" class="loading">Analisando sua situação...</p>

<div id="resultado" class="resultado"></div>

<p style="font-size:12px;color:#666;margin-top:10px;">
⚠️ Esta simulação é apenas uma estimativa informativa baseada nos dados informados.
</p>

</div>

<div class="cta" style="margin-top:60px;padding:40px;background:#2563eb;color:white;border-radius:14px;">
<h2>Pare de acompanhar o MEI manualmente</h2>
<button onclick="abrirModal()">Quero ser avisado antes</button>
</div>

</div>

<script>

async function analisar(){

  const valor=document.getElementById("valor").value;
  const botao=document.getElementById("botao");
  const loading=document.getElementById("loading");
  const resultado=document.getElementById("resultado");

  if(!valor||valor<=0){
    alert("Digite um valor válido.");
    return;
  }

  botao.disabled=true;
  botao.innerText="Analisando...";
  loading.style.display="block";
  resultado.innerHTML="";

  try{

    const resposta=await fetch(
      "https://radar-mei-api-production.up.railway.app/simular?valor="+valor
    );

    const dados=await resposta.json();

    let cor="#4CAF50";
    if(dados.risco==="moderado") cor="#FFC107";
    if(dados.risco==="alto") cor="#F44336";

    const score=Math.max(0,Math.round(100-dados.percentual_limite));

    const limiteMEI=81000;
    const restante=Math.max(0,limiteMEI-dados.projecao_anual);

    resultado.style.backgroundColor=cor;
    resultado.style.color="white";

    resultado.innerHTML=
      "Saúde Fiscal: "+score+"/100<br>"+
      "Risco: "+dados.risco.toUpperCase()+"<br>"+
      "Projeção anual: R$ "+dados.projecao_anual+"<br>"+
      "Uso do limite: "+dados.percentual_limite+"%<br><br>"+
      "⚠️ Faltam aproximadamente <b>R$ "+
      restante.toLocaleString('pt-BR')+
      "</b> para atingir o limite anual do MEI.";

    // ✅ modal inteligente (único gatilho)
    if(score<60 && !sessionStorage.getItem("modalExibido")){

      sessionStorage.setItem("modalExibido","true");

      setTimeout(()=>{
        preencherResumoModal(score,restante);
        abrirModal();
      },5000);

    }

  }catch(e){
    resultado.innerHTML="Erro ao consultar API.";
  }

  botao.disabled=false;
  botao.innerText="Analisar risco";
  loading.style.display="none";
}

function abrirModal(){
  document.getElementById("emailModal").style.display="flex";
}

function fecharModal(){
  document.getElementById("emailModal").style.display="none";
}

function preencherResumoModal(score,restante){
  document.getElementById("resumoModal").innerHTML=
    "Seu score atual é <b>"+score+"/100</b>.<br>"+
    "Você está a aproximadamente <b>R$ "+
    restante.toLocaleString('pt-BR')+
    "</b> do limite anual.<br><br>"+
    "Podemos avisar você automaticamente antes de qualquer risco.";
}

</script>

<div id="emailModal" style="
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.6);
justify-content:center;
align-items:center;
">

<div style="background:white;padding:30px;border-radius:12px;text-align:center;max-width:400px;">

<h2>Evite ultrapassar o limite sem perceber</h2>

<p id="resumoModal" style="color:#444;margin-top:10px;"></p>

<form action="https://formspree.io/f/mjgerynj" method="POST">

<input type="text" name="nome" placeholder="Seu primeiro nome" required style="padding:12px;width:90%;margin-top:10px;border-radius:8px;border:1px solid #ccc;">
<br><br>

<input type="email" name="email" placeholder="Seu melhor e-mail" required style="padding:12px;width:90%;border-radius:8px;border:1px solid #ccc;">
<br><br>

<button type="submit">Quero receber alertas</button>

</form>

<br>

<button onclick="fecharModal()" style="background:none;color:#666;">Cancelar</button>

</div>
</div>

</body>
</html>
